# 要求仕様書

## プロジェクト概要

| 項目 | 内容 |
|------|------|
| プロジェクト名 | さくらVPS SSL化ツールキット |
| 作成日 | 2024年12月28日 |
| 対象システム | さくらVPS上のirohaboard（教育研修システム） |
| 目的 | SSL非対応サイトのSSL化および暫定対応ドキュメントの提供 |

---

## 1. 背景・課題

### 1.1 現状の問題

- さくらのVPSで運用している教育研修サイト（irohaboard）がSSL化されていない
- 利用者がブラウザで「安全ではありません」という警告が表示されアクセスできない
- 一部の利用者は警告画面の回避方法がわからずアクセスを断念している

### 1.2 解決すべき課題

1. **短期対応**: 利用者が警告を回避してアクセスできるようドキュメントを整備
2. **恒久対応**: サイトをSSL化して警告が表示されないようにする
3. **安全対策**: SSL化作業中の障害に備えたバックアップ・復元手段の確保

---

## 2. 要求事項

### 2.1 利用者向けドキュメント（短期対応）

#### 2.1.1 機能要求

| ID | 要求内容 | 優先度 |
|----|---------|--------|
| DOC-001 | Windows PC（Chrome, Edge, Firefox）での警告回避手順を記載 | 必須 |
| DOC-002 | Mac（Safari, Chrome, Firefox）での警告回避手順を記載 | 必須 |
| DOC-003 | iPhone/iPad（Safari, Chrome）での警告回避手順を記載 | 必須 |
| DOC-004 | Android端末（Chrome, 標準ブラウザ）での警告回避手順を記載 | 必須 |
| DOC-005 | 各ブラウザの警告画面イメージを視覚的に表示 | 必須 |
| DOC-006 | クリックすべき箇所を明示（矢印、ハイライト等） | 必須 |
| DOC-007 | よくある質問（FAQ）を記載 | 必須 |
| DOC-008 | 問い合わせ先を記載 | 必須 |

#### 2.1.2 非機能要求

| ID | 要求内容 | 優先度 |
|----|---------|--------|
| DOC-N01 | HTMLファイルとして提供（単独で動作、外部依存なし） | 必須 |
| DOC-N02 | スマートフォンでも見やすいレスポンシブデザイン | 必須 |
| DOC-N03 | 印刷対応 | 推奨 |
| DOC-N04 | 問い合わせ先等のカスタマイズが容易 | 必須 |

---

### 2.2 SSL化スクリプト（恒久対応）

#### 2.2.1 機能要求

| ID | 要求内容 | 優先度 |
|----|---------|--------|
| SSL-001 | Let's Encrypt（無料SSL）を使用した証明書取得 | 必須 |
| SSL-002 | Apache Webサーバーへの自動設定 | 必須 |
| SSL-003 | HTTPからHTTPSへの自動リダイレクト設定 | 必須 |
| SSL-004 | 証明書の自動更新設定 | 必須 |
| SSL-005 | OS自動検出（CentOS, Ubuntu, Debian等） | 必須 |
| SSL-006 | パッケージマネージャー自動検出（yum, dnf, apt） | 必須 |
| SSL-007 | Webサーバー自動検出（httpd, apache2） | 必須 |
| SSL-008 | ファイアウォール設定（firewalld, ufw対応） | 必須 |
| SSL-009 | 対話形式でドメイン名・メールアドレスを入力 | 必須 |
| SSL-010 | 各ステップで確認プロンプトを表示 | 必須 |
| SSL-011 | 作業前にバックアップスクリプトを自動実行 | 必須 |

#### 2.2.2 非機能要求

| ID | 要求内容 | 優先度 |
|----|---------|--------|
| SSL-N01 | bashスクリプトとして実装（追加ランタイム不要） | 必須 |
| SSL-N02 | root権限チェック | 必須 |
| SSL-N03 | エラー発生時に処理を停止 | 必須 |
| SSL-N04 | 色付きメッセージで状態を視覚的に表示 | 推奨 |
| SSL-N05 | 30分以内で完了（トラブルがない場合） | 目標 |

---

### 2.3 バックアップスクリプト

#### 2.3.1 機能要求

| ID | 要求内容 | 優先度 |
|----|---------|--------|
| BKP-001 | Apache設定ファイルのバックアップ | 必須 |
| BKP-002 | Let's Encrypt設定のバックアップ | 必須 |
| BKP-003 | irohaboardファイル一式のバックアップ | 必須 |
| BKP-004 | MySQLデータベースのバックアップ | 必須 |
| BKP-005 | ファイアウォール設定のバックアップ | 推奨 |
| BKP-006 | crontab設定のバックアップ | 推奨 |
| BKP-007 | バックアップの圧縮（tar.gz, gzip） | 必須 |
| BKP-008 | タイムスタンプ付きディレクトリに保存 | 必須 |
| BKP-009 | 最新バックアップへのシンボリックリンク作成 | 推奨 |
| BKP-010 | バックアップ情報ファイルの作成 | 必須 |

#### 2.3.2 非機能要求

| ID | 要求内容 | 優先度 |
|----|---------|--------|
| BKP-N01 | バックアップ保存先: /root/ssl_backup/ | 必須 |
| BKP-N02 | irohaboardパスの自動検出 | 推奨 |
| BKP-N03 | DB接続情報の自動検出（database.phpから） | 推奨 |

---

### 2.4 復元スクリプト

#### 2.4.1 機能要求

| ID | 要求内容 | 優先度 |
|----|---------|--------|
| RST-001 | バックアップ一覧の表示・選択 | 必須 |
| RST-002 | 復元項目の選択（全部/Apache/irohaboard/DB） | 必須 |
| RST-003 | 復元前の確認プロンプト | 必須 |
| RST-004 | 復元前に現在設定を退避 | 必須 |
| RST-005 | Webサーバーの停止・起動制御 | 必須 |
| RST-006 | データベースの復元 | 必須 |

#### 2.4.2 非機能要求

| ID | 要求内容 | 優先度 |
|----|---------|--------|
| RST-N01 | 引数なしで実行時はバックアップ一覧を表示 | 必須 |
| RST-N02 | バックアップパスを引数で直接指定可能 | 必須 |
| RST-N03 | /root/ssl_backup/latest で最新を指定可能 | 推奨 |

---

## 3. システム構成

### 3.1 対象環境

```
┌─────────────────────────────────────────────┐
│  さくらのVPS                                 │
│  ┌─────────────────────────────────────┐   │
│  │  OS: CentOS 7/8, Ubuntu, etc.       │   │
│  │  Web: Apache (httpd/apache2)        │   │
│  │  App: irohaboard (PHP/CakePHP)      │   │
│  │  DB:  MySQL/MariaDB                 │   │
│  └─────────────────────────────────────┘   │
└─────────────────────────────────────────────┘
```

### 3.2 SSL化後の構成

```
利用者 ─── HTTPS (443) ───→ Apache ───→ irohaboard
              ↑
        Let's Encrypt
        SSL証明書
```

---

## 4. 制約事項

### 4.1 技術的制約

| ID | 制約内容 |
|----|---------|
| CON-001 | Let's EncryptはIPアドレスには証明書を発行できない（独自ドメイン必須） |
| CON-002 | 証明書取得時に外部からサーバーへのアクセスが必要（80番ポート開放必須） |
| CON-003 | Let's Encrypt証明書の有効期限は90日（自動更新で対応） |
| CON-004 | Nginx環境は本スクリプトの対象外（Apache専用） |

### 4.2 運用上の制約

| ID | 制約内容 |
|----|---------|
| CON-101 | SSL化作業中、数秒間サイトにアクセスできなくなる可能性あり |
| CON-102 | さくらVPSのパケットフィルターで443ポートを許可する必要あり |

---

## 5. テスト要件

### 5.1 SSL化スクリプト

| テスト項目 | 確認内容 |
|-----------|---------|
| 証明書取得 | certbot certificatesで証明書が表示される |
| HTTPS接続 | https://ドメイン でアクセスできる |
| リダイレクト | http://ドメイン がhttpsにリダイレクトされる |
| 鍵マーク | ブラウザに鍵マークが表示される |
| 自動更新 | certbot renew --dry-run が成功する |

### 5.2 バックアップ・復元

| テスト項目 | 確認内容 |
|-----------|---------|
| バックアップ作成 | /root/ssl_backup/にディレクトリが作成される |
| ファイル存在確認 | Apache設定、irohaboard、DBダンプが存在する |
| 復元実行 | 復元後にサイトが正常動作する |

---

## 6. 成果物

| 成果物 | ファイル名 | 形式 |
|-------|-----------|------|
| README | README.md | Markdown |
| 要求仕様書 | REQUIREMENTS.md | Markdown |
| SSL化スクリプト | ssl_setup.sh | Bash |
| バックアップスクリプト | backup_server.sh | Bash |
| 復元スクリプト | restore_server.sh | Bash |
| 手動作業手順書 | さくらVPS_SSL化手順書.md | Markdown |
| 利用者向け案内（HTML） | 教育研修サイト_アクセス手順書.html | HTML |
| 利用者向け案内（MD） | 教育研修サイト_アクセス手順書.md | Markdown |

---

## 7. 用語集

| 用語 | 説明 |
|------|------|
| SSL/TLS | 通信を暗号化するプロトコル。HTTPSはSSL/TLSを使用 |
| Let's Encrypt | 無料でSSL証明書を発行する認証局 |
| Certbot | Let's Encrypt証明書を取得・管理するツール |
| irohaboard | オープンソースのeラーニングシステム |
| さくらのVPS | さくらインターネットが提供するVPSサービス |
| Apache | オープンソースのWebサーバーソフトウェア |

---

## 更新履歴

| 日付 | バージョン | 内容 |
|------|-----------|------|
| 2024-12-28 | 1.0 | 初版作成 |
